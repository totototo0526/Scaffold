# 技術仕様書：HMS画面実装自動化ツール

## 1. 概要
本ツールのバックエンドロジックは、PostgreSQL関数群に集約される。n8nは、フロントエンドからのリクエストを受け取り、適切なPostgreSQL関数を呼び出すためのシンプルなAPIゲートウェイとして機能する。

フロントエンド（SvelteKit）は、本仕様書で定義されたAPIエンドポイントとのみ通信を行う。

---
## 2. ツール用データベーススキーマ
ツール自体の動作ルールを定義するため、以下のテーブルをデータベースに作成する。

### 2.1. UI部品定義テーブル (`generator_components`)
ツールのUI（項目定義グリッドのチェックボックスなど）を動的に生成するための基本定義。
```sql
CREATE TABLE generator_components (
  component_id VARCHAR(50) PRIMARY KEY, -- 'list', 'edit_form'など、UI部品の内部ID
  label VARCHAR(100),                  -- UIに表示する名前 (例: '一覧 (C3)')
  target_mst_kbn VARCHAR(4)            -- 対応するm_hanyoのmst_kbn
);
```

### 2.2. UI部品詳細ルール定義テーブル (`generator_properties`)
各UI部品が持つ詳細設定（例: リンクキーは`koumoku10`）のルールを定義する。
```sql
CREATE TABLE generator_properties (
  property_id SERIAL PRIMARY KEY,
  component_id VARCHAR(50),             -- どのUI部品のルールか (generator_components.component_idへの外部キー)
  property_name VARCHAR(100),            -- ルールの内部名 (例: 'link_key_column')
  target_koumoku VARCHAR(20)             -- 対応するm_hanyoのカラム名 (例: 'koumoku10')
);
```
---
## 3. APIエンドポイント定義 (n8n Webhook)

### 3.1. `GET /api/menu-tree`
-   **目的**: ダッシュボードのメニューツリーを描画するためのデータを取得する。
-   **処理**: `m_content`テーブルを元に親子関係を構造化したJSONを返すPostgreSQL関数 `fnc_get_menu_tree()` を呼び出す。
-   **レスポンス**: `[{ "id": "mhin", "title": "商品管理", "children": [...] }, ...]` のようなツリー構造のJSON。

### 3.2. `GET /api/screen-definition?id={画面ID}`
-   **目的**: 既存画面の編集時に、ウィザードに現在の設定値を表示するためのデータを取得する。
-   **処理**: 指定された画面ID（例: `msyohin`）を元に、関連する`m_hanyo`レコード（`C1`, `C2`, `C3`など）を全て取得するPostgreSQL関数 `fnc_get_screen_definition('{画面ID}')` を呼び出す。
-   **レスポンス**: `{ "basic_info": {...}, "fields": [...] }` のようなJSON。

### 3.3. `POST /api/generate-sql`
-   **目的**: ウィザードで入力された定義を元に、SQLスクリプトと関数雛形を生成する。
-   **リクエストボディ (JSON)**: ウィザードの全ステップの入力内容を含む。
    ```json
    {
      "basic_info": { "screen_name": "...", "url_id": "...", ... },
      "fields": [
        { "db_column": "hin_cd", "display_name": "品番", "ui_type": "string", "use_in_list": true, ... },
        ...
      ],
      "actions": { "enable_new": true, "enable_edit": true, ... }
    }
    ```
-   **処理**: 受け取ったJSONを引数として、後述のSQL生成ロジックを持つマスター関数 `fnc_generate_scaffolding_sql('{json}')` を呼び出す。
-   **レスポンス**: `{ "m_hanyo_sql": "...", "m_content_sql": "...", "functions_sql": "..." }` のような、生成されたスクリプトを含むJSON。

---
### 4. SQL生成ロジックの概要 (`fnc_generate_scaffolding_sql`関数)

このPostgreSQL関数が、本ツールのコアエンジンとなる。

-   **入力**: `POST /api/generate-sql`から渡されたJSONオブジェクト。
-   **処理**:
    1.  JSON内の`basic_info`を元に、`m_content`および`m_hanyo`の`CB`, `CC`レコードに対応する`INSERT`文を生成する。
    2.  JSON内の`fields`配列をループ処理する。
    3.  各項目について、`use_in_list`, `use_in_search`, `use_in_form` のフラグを確認する。
    4.  `generator_components`と`generator_properties`テーブル（ルール定義テーブル）を参照し、どの`mst_kbn`を使い、どの`koumoku`にどの値を設定すべきかを判断しながら、`C1`, `C2`, `C3`の`INSERT`文を動的に組み立てる。
    5.  JSON内の`actions`を元に、`CD`レコードの`INSERT`文を生成する。
    6.  `basic_info`の情報を元に、`fnc_query_list_*`などの関数雛形の文字列を生成する。
-   **出力**: 生成された3種類のスクリプト（`m_hanyo`, `m_content`, functions）を返す。